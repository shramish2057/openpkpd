name: CI

on:
  push:
  pull_request:

jobs:
  # ===========================================================================
  # Python Trial Tests (Fast, no Julia required)
  # ===========================================================================
  python-trial-tests:
    runs-on: ubuntu-latest
    name: Python Trial Module Tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-cov
          cd packages/python && pip install -e .

      - name: Run trial module tests
        run: |
          cd packages/python && python -m pytest tests/test_trial.py -v --tb=short

  # ===========================================================================
  # Julia + Python Integration Tests
  # ===========================================================================
  julia-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        julia-version: ["1.10"]

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.julia-version }}

      - name: Test OpenPKPDCore
        shell: bash
        run: |
          julia -e 'using Pkg; Pkg.activate("packages/core"); Pkg.instantiate(); Pkg.test()'

      - name: Golden validation (replay artifacts)
        shell: bash
        run: |
          julia validation/scripts/run_golden_validation.jl

      - name: CLI smoke test
        shell: bash
        run: |
          validation/scripts/smoke_cli.sh

      - name: Python bindings smoke test
        shell: bash
        run: |
          packages/python/scripts/smoke_python.sh

      - name: Docs executable contracts
        shell: bash
        run: |
          docs/examples/run_all.sh

      - name: Build documentation site
        shell: bash
        run: |
          docs/build_docs.sh

      - name: Use case (FIH dose exploration)
        shell: bash
        run: |
          docs/examples/use_cases/fih_dose_exploration/run_and_validate.sh

      - name: Use case (PKPD biomarker turnover)
        shell: bash
        run: |
          docs/examples/use_cases/pkpd_biomarker_turnover/run_and_validate.sh

      - name: Real-world study (theophylline theo_sd)
        shell: bash
        run: |
          docs/examples/real_world_validation/datasets/theophylline_theo_sd/run_and_validate.sh

      - name: Real-world study (theophylline theo_md multiple dose)
        shell: bash
        run: |
          docs/examples/real_world_validation/datasets/theophylline_theo_md/run_and_validate.sh

      - name: Real-world study (warfarin PKPD)
        shell: bash
        run: |
          docs/examples/real_world_validation/datasets/warfarin_nlmixr2data/run_and_validate.sh

      - name: Check version consistency
        shell: bash
        run: |
          julia --project=packages/core validation/scripts/check_version_consistency.jl

  # ===========================================================================
  # Python Integration Tests (require Julia)
  # ===========================================================================
  python-integration-tests:
    runs-on: ubuntu-latest
    name: Python Integration Tests (NCA, Simulation)

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: julia-actions/setup-julia@v2
        with:
          version: "1.10"

      - name: Install dependencies
        run: |
          julia -e 'using Pkg; Pkg.activate("packages/core"); Pkg.instantiate()'
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-cov
          cd packages/python && pip install -e .

      - name: Run NCA tests
        run: |
          cd packages/python && python -m pytest tests/test_nca.py -v --tb=short

      - name: Run simulation tests
        run: |
          cd packages/python && python -m pytest tests/test_simulate.py -v --tb=short

      - name: Run replay tests
        run: |
          cd packages/python && python -m pytest tests/test_replay.py -v --tb=short

      - name: Run trial tests
        run: |
          cd packages/python && python -m pytest tests/test_trial.py -v --tb=short

      - name: Run all Python tests
        run: |
          cd packages/python && python -m pytest tests/ -v --tb=short

  # ===========================================================================
  # Documentation Build
  # ===========================================================================
  docs:
    runs-on: ubuntu-latest
    name: Documentation Build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements.txt

      - name: Build documentation
        run: |
          mkdocs build --strict

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: site/
          retention-days: 7

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  ci-complete:
    runs-on: ubuntu-latest
    needs: [python-trial-tests, julia-tests, python-integration-tests, docs]
    if: always()
    name: CI Complete

    steps:
      - name: Check all jobs
        run: |
          echo "Python Trial Tests: ${{ needs.python-trial-tests.result }}"
          echo "Julia Tests: ${{ needs.julia-tests.result }}"
          echo "Python Integration Tests: ${{ needs.python-integration-tests.result }}"
          echo "Documentation: ${{ needs.docs.result }}"

          if [[ "${{ needs.python-trial-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.julia-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.python-integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.docs.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi

          echo "All CI checks passed!"
